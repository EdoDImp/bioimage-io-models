<docs lang="markdown">
# Unet Segmentation
A U-net model for image segmentation.

## Usage

### Inference
Load your image file and run the model.

### Training
For training, your images should be organized according to the following structure

```
    - train
    - sample1
        - channelA.png
        - channelB.png
        - channelC.png
    - sample2
        - channelA.png
        - channelB.png
        - channelC.png
    - ...
    - valid
    - sample20
        - channelA.png
        - channelB.png
        - channelC.png
    - ...
    - test
    - sample43
        - channelA.png
        - channelC.png
    - sample44
        - channelA.png
        - channelC.png
```
In the above folder structure, `train/valid/test` are three folders, `sample1`...`sample44` are sample folders, within the sample folder, it contains images with different channels.

For the naming, you have to use `train`/`valid`/`test` as the top level folder name, but the sample name can be choose freely.

Once you organized the images, 

</docs>

<config lang="yaml">
name: Unet Segmentation
type: model
tags: ["ImageJ", "CellProfiler", "ImJoy", "Ilastik"]
cover: ''
version: 0.1.0
api_version: 0.1.6
description: A U-net model for image segmentation.
icon: extension
permissions: []
requirements: []
dependencies: []
</config>

<script tag="Ilastik;ImJoy;CellProfiler" lang="python">
from bioimage import api

class Model():
    def setup(self):
        self.model = api.loadModel('https://.../model.onnx')
        api.register(
            type='model',
            input_shape=[None, 4, 256, 256],
            input_shape=[None, 1, 256, 256],
            fit=self.train,
            transform=self.predict
        )

    def predict(self, X):
        X = X / X.max()
        return self.model.predict(X)

    def train(self, X, y):
        X = X / X.max()
        return self.model.fit(X, y)

    def test_predict(self):
        import numpy as np
        result = self.predict(np.random.randint(255, size=(1, 4, 256, 256)))
        assert result.shape == (1, 1, 256, 256)

api.export(Model())
</script>

<script tag="ImageJ" lang="groovy">
import bioimage.api

class Model {
    def setup() {
        this.model = api.loadModel("https://.../model.onnx")
        api.register(
            type='model',
            input_shape=[null, 4, 256, 256],
            input_shape=[null, 1, 256, 256],
            fit=this.train,
            transform=this.predict
        )
    }

    def predict(X) {
        X = X / X.max()
        return this.model.predict(X)
    }

    def train(X, y){
        X = X / X.max()
        return this.model.fit(X, y)
    }

}
api.export(new Model())
</script>